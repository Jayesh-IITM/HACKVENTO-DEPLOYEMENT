<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard ¬∑ Placement Portal</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .admin-shell { max-width: 1400px; margin: 0 auto; }
        
        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--glass);
            border: var(--border);
            border-radius: var(--radius);
            margin-bottom: 24px;
        }
        
        .admin-header .brand { display: flex; align-items: center; gap: 12px; }
        
        .admin-header .brand h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #7c3aed, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .admin-header .brand span { color: var(--muted); font-size: 13px; }
        
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        
        .tab-btn {
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            background: var(--glass);
            border: var(--border);
            color: var(--muted);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
        }
        
        .tab-btn:hover { background: rgba(255, 255, 255, 0.08); color: var(--text); }
        
        .tab-btn.active {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.3), rgba(6, 182, 212, 0.2));
            color: #fff;
            border-color: rgba(124, 58, 237, 0.5);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: floatUp 0.4s ease; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            padding: 20px;
            border-radius: var(--radius);
            background: var(--glass);
            border: var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 4px; height: 100%;
            background: linear-gradient(180deg, #7c3aed, #06b6d4);
            border-radius: 4px 0 0 4px;
        }
        
        .stat-card.orange::before { background: linear-gradient(180deg, #f59e0b, #ef4444); }
        
        .stat-card .label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }
        
        .stat-card .value { font-size: 28px; font-weight: 700; color: #fff; }
        .stat-card .suffix { font-size: 14px; color: var(--muted); }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .chart-card {
            padding: 24px;
            border-radius: var(--radius);
            background: var(--glass);
            border: var(--border);
        }
        
        .chart-card h3 { margin-bottom: 16px; font-size: 16px; }
        .chart-container { height: 280px; position: relative; }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            z-index: 2000;
        }

        .loading-overlay.active { display: flex; }

        .loading-card {
            width: min(520px, calc(100vw - 32px));
            padding: 20px 18px;
            border-radius: var(--radius);
            background: var(--glass);
            border: var(--border);
            display: flex;
            gap: 14px;
            align-items: center;
        }

        .loading-spinner {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            border: 3px solid rgba(255, 255, 255, 0.18);
            border-top-color: #7c3aed;
            border-right-color: #06b6d4;
            animation: spin 0.9s linear infinite;
            flex: 0 0 auto;
        }

        .loading-title {
            font-weight: 700;
            color: #fff;
            font-size: 14px;
            line-height: 1.2;
        }

        .loading-subtitle {
            margin-top: 4px;
            color: var(--muted);
            font-size: 13px;
        }

        .loading-dots {
            display: inline-flex;
            gap: 2px;
            margin-left: 4px;
        }

        .loading-dots span {
            display: inline-block;
            opacity: 0.25;
            animation: dotPulse 1.1s infinite;
        }

        .loading-dots span:nth-child(2) { animation-delay: 0.15s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.3s; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes dotPulse { 0%, 100% { opacity: 0.25; } 50% { opacity: 0.95; } }

        @media (prefers-reduced-motion: reduce) {
            .loading-spinner { animation: none; }
            .loading-dots span { animation: none; opacity: 0.95; }
        }
        
        .data-table { width: 100%; border-collapse: collapse; }
        
        .data-table th, .data-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .data-table th {
            color: var(--muted);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }
        
        .data-table td { color: var(--text); }
        .data-table tbody tr:hover { background: rgba(255, 255, 255, 0.03); }
        
        .action-btn {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition);
            margin-right: 6px;
        }
        
        .action-btn.approve { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .action-btn.approve:hover { background: rgba(34, 197, 94, 0.4); }
        .action-btn.reject { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .action-btn.reject:hover { background: rgba(239, 68, 68, 0.4); }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.pending { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .status-badge.approved, .status-badge.verified { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .status-badge.rejected { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            place-items: center;
        }
        
        .modal-overlay.active { display: grid; }
        
        .modal-box {
            background: var(--bg-alt);
            border: var(--border);
            border-radius: var(--radius);
            padding: 28px;
            max-width: 500px;
            width: 90%;
            animation: floatUp 0.3s ease;
        }
        
        .modal-box h3 { margin-bottom: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .master-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            padding-bottom: 12px;
        }
        
        .master-tab {
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: var(--muted);
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all var(--transition);
        }
        
        .master-tab:hover { color: var(--text); }
        .master-tab.active { background: rgba(124, 58, 237, 0.2); color: #fff; }
        .master-content { display: none; }
        .master-content.active { display: block; }
        
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }
        
        .item-chip {
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.04);
            border: var(--border);
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-chip.branch-chip { cursor: pointer; }
        .item-chip.branch-chip:hover { background: rgba(255, 255, 255, 0.08); }
        .item-chip.branch-chip.active { border-color: rgba(124, 58, 237, 0.55); background: rgba(124, 58, 237, 0.10); }

        .count-pill {
            padding: 3px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.10);
            background: rgba(255, 255, 255, 0.06);
            color: #fff;
            font-weight: 700;
            font-size: 12px;
            line-height: 1.6;
        }

        .branch-students-panel { margin-top: 16px; }
        
        .item-chip span { font-weight: 600; }
        
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .admin-header { flex-direction: column; gap: 16px; }
        }
    </style>
</head>
<body>
    <!-- Session Selector Bar -->
    <div class="session-selector-bar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 24px; color: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 999;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <span style="font-weight: 600; font-size: 14px;">üìÖ Active Session:</span>
            <select id="session-selector" style="padding: 8px 12px; border-radius: 8px; border: none; font-size: 14px; min-width: 250px; cursor: pointer; background: white; color: #1f2937;">
                <option value="">Loading sessions...</option>
            </select>
            <button class="btn btn-secondary" onclick="refreshSessionData()" style="padding: 8px 16px; font-size: 14px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">üîÑ Refresh</button>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="openSessionModal()" style="padding: 8px 16px; font-size: 14px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">‚öôÔ∏è Manage Sessions</button>
            <button class="btn btn-primary" onclick="openBatchModal()" style="padding: 8px 16px; font-size: 14px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">üéì Manage Batches</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" role="status" aria-live="polite" aria-busy="true">
        <div class="loading-card">
            <div class="loading-spinner" aria-hidden="true"></div>
            <div>
                <div class="loading-title" id="loadingTitle">Loading details</div>
                <div class="loading-subtitle" id="loadingSubtitle">
                    <span id="loadingSubtitleText">Please wait</span>
                    <span class="loading-dots" aria-hidden="true"><span>.</span><span>.</span><span>.</span></span>
                </div>
            </div>
        </div>
    </div>
    
    <main>
        <div class="admin-shell">
            <header class="admin-header">
                <div class="brand">
                    <div class="pill">üéì Admin Control Center</div>
                    <div>
                        <h1>Placement Portal</h1>
                        <span>TPO Dashboard</span>
                    </div>
                </div>
                <div class="user-badge">
                    <div class="user-avatar">A</div>
                    <div>
                        <div style="font-weight: 600;" id="userName">Admin</div>
                        <div class="minor" id="userEmail">admin@university.edu</div>
                    </div>
                    <button class="btn btn-ghost" onclick="logout()" style="margin-left: 12px;">Logout</button>
                </div>
            </header>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('overview')">üìä Overview</button>
                <button class="tab-btn" onclick="switchTab('companies')">üè¢ Companies</button>
                <button class="tab-btn" onclick="switchTab('verification')">‚úì Verification Queue</button>
                <button class="tab-btn" onclick="switchTab('jobs')">üíº Job Approvals</button>
                <button class="tab-btn" onclick="switchTab('blacklist')">üö´ Blacklist</button>
                <button class="tab-btn" onclick="switchTab('master')">‚öôÔ∏è Master Data</button>
                <button class="tab-btn" onclick="switchTab('announcements')">üì¢ Announcements</button>
            </div>

            <!-- Overview Tab -->
            <div id="tab-overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card"><div class="label">Total Students</div><div class="value" id="totalStudents">-</div></div>
                    <div class="stat-card"><div class="label">Placed</div><div class="value" id="placedStudents">-</div></div>
                    <div class="stat-card"><div class="label">Unplaced</div><div class="value" id="unplacedStudents">-</div></div>
                    <div class="stat-card"><div class="label">Placement Rate</div><div class="value" id="placementRate">-</div><span class="suffix">%</span></div>
                    <div class="stat-card orange"><div class="label">Highest Package</div><div class="value" id="highestPackage">-</div><span class="suffix">LPA</span></div>
                    <div class="stat-card orange"><div class="label">Average Package</div><div class="value" id="avgPackage">-</div><span class="suffix">LPA</span></div>
                    <div class="stat-card"><div class="label">Active Companies</div><div class="value" id="activeCompanies">-</div></div>
                    <div class="stat-card"><div class="label">Pending Jobs</div><div class="value" id="pendingJobs">0</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h3>Placement Status</h3><div class="chart-container"><canvas id="placementPieChart"></canvas></div></div>
                    <div class="chart-card"><h3>Department-wise Placement</h3><div class="chart-container"><canvas id="deptBarChart"></canvas></div></div>
                </div>

                <!-- Enhanced Analytics Section -->
                <div style="margin-top: 24px;">
                    <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">üìä Advanced Analytics</h3>
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>Application Status Distribution</h3>
                            <div class="chart-container"><canvas id="applicationStatusChart"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3>Top 10 Companies by Applications</h3>
                            <div class="chart-container"><canvas id="topCompaniesChart"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3>Monthly Applications Trend</h3>
                            <div class="chart-container"><canvas id="applicationsTrendChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- Additional Analytics -->
                <div style="margin-top: 24px;">
                    <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">üíº Placement Insights</h3>
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>Package Range Distribution</h3>
                            <div class="chart-container"><canvas id="packageRangeChart"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3>Applications vs Placements by Branch</h3>
                            <div class="chart-container"><canvas id="branchComparisonChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Companies Tab -->
            <div id="tab-companies" class="tab-content">
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">üè¢ Company Placement Progress</h2>
                    <p style="color: var(--muted);">Track hiring progress and placement statistics for each company</p>
                </div>
                
                <div id="companyProgressList" style="display: grid; gap: 16px;">
                    <div style="text-align: center; padding: 60px 40px; color: var(--muted); background: var(--glass); border: var(--border); border-radius: var(--radius);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                        <div style="font-size: 18px; margin-bottom: 8px;">Loading company data...</div>
                        <div style="font-size: 14px;">Please wait while we fetch the placement progress</div>
                    </div>
                </div>
            </div>

            <!-- Verification Queue Tab -->
            <div id="tab-verification" class="tab-content">
                <div class="card glass" style="padding: 24px;">
                    <div class="section-header">
                        <h3>Student Verification Queue</h3>
                        <select id="verificationFilter" onchange="loadVerificationQueue()" style="width: auto;">
                            <option value="Pending">Pending</option>
                            <option value="Verified">Verified</option>
                            <option value="Rejected">Rejected</option>
                            <option value="All">All</option>
                        </select>
                    </div>
                    <table class="data-table">
                        <thead><tr><th>Student</th><th>Email</th><th>Branch</th><th>Submitted</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="verificationTableBody"><tr><td colspan="6" class="empty-state">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Job Approvals Tab -->
            <div id="tab-jobs" class="tab-content">
                <div class="card glass" style="padding: 24px;">
                    <div class="section-header"><h3>Pending Job Approvals</h3></div>
                    <table class="data-table">
                        <thead><tr><th>Company</th><th>Job Title</th><th>Type</th><th>Location</th><th>Package</th><th>Deadline</th><th>Actions</th></tr></thead>
                        <tbody id="jobsTableBody"><tr><td colspan="7" class="empty-state">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Blacklist Tab -->
            <div id="tab-blacklist" class="tab-content">
                <div class="card glass" style="padding: 24px;">
                    <div class="section-header">
                        <h3>Blacklisted Students</h3>
                        <button class="btn btn-primary" onclick="openBlacklistModal()">+ Add to Blacklist</button>
                    </div>
                    <table class="data-table">
                        <thead><tr><th>Student</th><th>Reason</th><th>Severity</th><th>Date</th><th>Actions</th></tr></thead>
                        <tbody id="blacklistTableBody"><tr><td colspan="5" class="empty-state">No blacklisted students</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Master Data Tab -->
            <div id="tab-master" class="tab-content">
                <div class="card glass" style="padding: 24px;">
                    <h3 style="margin-bottom: 20px;">Master Data Management</h3>
                    <div class="master-tabs">
                        <button class="master-tab active" onclick="switchMasterTab('departments')">Departments</button>
                        <button class="master-tab" onclick="switchMasterTab('batches')">Batch Years</button>
                        <button class="master-tab" onclick="switchMasterTab('skills')">Skills</button>
                    </div>
                    <div id="master-departments" class="master-content active">
                        <div class="section-header">
                            <span class="minor">Manage department/branches</span>
                            <button class="btn btn-ghost" onclick="openAddModal('department')">+ Add Department</button>
                        </div>
                        <div class="item-grid" id="departmentsList"></div>

                        <div id="branchStudentsPanel" class="branch-students-panel" style="display:none;">
                            <div class="section-header" style="margin-top: 16px;">
                                <div>
                                    <h3 id="branchStudentsTitle" style="margin-bottom: 4px;">Branch Students</h3>
                                    <div class="minor" id="branchStudentsSummary">Select a branch to view students</div>
                                </div>
                                <button class="btn btn-ghost" onclick="closeBranchStudents()">Close</button>
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Email</th>
                                        <th>Enrollment</th>
                                        <th>CGPA</th>
                                        <th>Status</th>
                                        <th>Package (LPA)</th>
                                    </tr>
                                </thead>
                                <tbody id="branchStudentsBody"><tr><td colspan="6" class="empty-state">Select a branch</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="master-batches" class="master-content">
                        <div class="section-header">
                            <span class="minor">Manage graduation batch years</span>
                            <button class="btn btn-ghost" onclick="openAddModal('batch')">+ Add Batch Year</button>
                        </div>
                        <div class="item-grid" id="batchesList"></div>
                    </div>
                    <div id="master-skills" class="master-content">
                        <div class="section-header">
                            <span class="minor">Manage skill taxonomy</span>
                            <button class="btn btn-ghost" onclick="openAddModal('skill')">+ Add Skill</button>
                        </div>
                        <div class="item-grid" id="skillsList"></div>
                    </div>
                </div>
            </div>

            <!-- Announcements Tab -->
            <div id="tab-announcements" class="tab-content">
                <div class="grid grid-2">
                    <div class="card glass" style="padding: 24px;">
                        <h3 style="margin-bottom: 16px;">Create Announcement</h3>
                        <form id="announcementForm" onsubmit="createAnnouncement(event)">
                            <div class="form-group"><label>Title</label><input type="text" id="annTitle" placeholder="Announcement title" required></div>
                            <div class="form-group"><label>Message</label><textarea id="annMessage" placeholder="Write your announcement..." required></textarea></div>
                            <div class="form-group">
                                <label>Target Audience</label>
                                <select id="annTarget"><option value="">All Users</option><option value="1">Students Only</option><option value="2">Companies Only</option></select>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Broadcast Announcement</button>
                        </form>
                    </div>
                    <div class="card glass" style="padding: 24px;">
                        <h3 style="margin-bottom: 16px;">Recent Announcements</h3>
                        <div id="announcementsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Blacklist Modal -->
    <div class="modal-overlay" id="blacklistModal">
        <div class="modal-box">
            <h3>Add Student to Blacklist</h3>
            <form id="blacklistForm" onsubmit="addToBlacklist(event)">
                <div class="form-group"><label>Student ID</label><input type="number" id="blStudentId" required></div>
                <div class="form-group"><label>Reason</label><textarea id="blReason" required></textarea></div>
                <div class="form-row">
                    <div class="form-group"><label>Severity</label><select id="blSeverity"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option><option value="Critical">Critical</option></select></div>
                    <div class="form-group"><label>Duration (days, 0=permanent)</label><input type="number" id="blDuration" value="0"></div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('blacklistModal')" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add to Blacklist</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal-box">
            <h3 id="addModalTitle">Add Item</h3>
            <form id="addForm" onsubmit="submitAddForm(event)">
                <div id="addFormFields"></div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('addModal')" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add</button>
                </div>
            </form>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const API_BASE = window.API_BASE || '/api';
        const token = localStorage.getItem('token');
        const userData = localStorage.getItem('user');

        document.addEventListener('DOMContentLoaded', function() {
            if (!token || !userData) { localStorage.clear(); window.location.href = 'index.html'; return; }
            try {
                const user = JSON.parse(userData);
                if (!user || user.role_id !== 3) { localStorage.clear(); window.location.href = 'index.html'; return; }
                document.getElementById('userEmail').textContent = user.email || 'admin@university.edu';
            } catch(e) { localStorage.clear(); window.location.href = 'index.html'; return; }
            initialLoad();
        });

        let loadingCounter = 0;
        let overviewLoadedOnce = false;
        function setLoading(isLoading, title = 'Loading details', subtitle = 'Please wait') {
            const overlay = document.getElementById('loadingOverlay');
            if (!overlay) return;
            const titleEl = document.getElementById('loadingTitle');
            const subtitleTextEl = document.getElementById('loadingSubtitleText');

            if (isLoading) {
                loadingCounter += 1;
                if (titleEl) titleEl.textContent = title;
                if (subtitleTextEl) subtitleTextEl.textContent = subtitle;
            } else {
                loadingCounter = Math.max(0, loadingCounter - 1);
            }

            const active = loadingCounter > 0;
            overlay.classList.toggle('active', active);
            overlay.setAttribute('aria-busy', active ? 'true' : 'false');
        }

        async function initialLoad() {
            try {
                if (!overviewLoadedOnce) {
                    setLoading(true, 'Loading details', 'Please wait');
                    try {
                        await loadOverview();
                        overviewLoadedOnce = true;
                    } finally {
                        setLoading(false);
                    }
                } else {
                    await loadOverview();
                }

                await Promise.all([
                    loadPendingJobs(),
                    loadBlacklist(),
                    loadMasterData(),
                    loadAnnouncements()
                ]);
            } finally {
                // Loader is intentionally Overview-only.
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'verification') loadVerificationQueue();
            if (tabName === 'companies') loadCompanyProgress();
        }

        function switchMasterTab(tabName) {
            document.querySelectorAll('.master-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.master-tab').forEach(b => b.classList.remove('active'));
            document.getElementById('master-' + tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function showToast(msg, type = 'info') {
            let stack = document.getElementById('toast-stack');
            if (!stack) { stack = document.createElement('div'); stack.id = 'toast-stack'; stack.className = 'toast-stack'; document.body.appendChild(stack); }
            const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = msg; stack.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            const res = await fetch(`${API_BASE}${endpoint}`, options).catch(networkError => {
                throw new Error('Cannot connect to server. Please ensure the backend is running.');
            });
            
            const data = await res.json();
            
            if (!res.ok) {
                throw new Error(data.error || `Request failed with status ${res.status}`);
            }
            
            return data;
        }

        async function loadOverview() {
            try {
                console.log('üìä Loading overview data...');
                const [analyticsData, applicationsData, jobsData] = await Promise.all([
                    apiCall('/admin/analytics'),
                    apiCall('/admin/applications').catch(err => { console.error('Applications error:', err); return { data: [] }; }),
                    apiCall('/admin/jobs').catch(err => { console.error('Jobs error:', err); return { data: [] }; })
                ]);
                
                console.log('üì¶ Received data:', { 
                    analytics: analyticsData, 
                    applications: applicationsData, 
                    jobs: jobsData 
                });
                
                if (analyticsData.overall) {
                    document.getElementById('totalStudents').textContent = analyticsData.overall.total_students || 0;
                    document.getElementById('placedStudents').textContent = analyticsData.overall.placed_students || 0;
                    document.getElementById('unplacedStudents').textContent = (analyticsData.overall.total_students - analyticsData.overall.placed_students) || 0;
                    document.getElementById('placementRate').textContent = analyticsData.overall.placement_percentage || 0;
                    document.getElementById('activeCompanies').textContent = analyticsData.overall.total_companies || 0;

                    const highestPackage = Number(analyticsData.overall.highest_package);
                    const averagePackage = Number(analyticsData.overall.average_package);
                    document.getElementById('highestPackage').textContent = (Number.isFinite(highestPackage) && highestPackage > 0) ? highestPackage.toFixed(2) : '-';
                    document.getElementById('avgPackage').textContent = (Number.isFinite(averagePackage) && averagePackage > 0) ? averagePackage.toFixed(2) : '-';
                }
                
                // Render existing charts
                renderPieChart(analyticsData.overall?.placed_students || 0, analyticsData.overall?.total_students || 0);
                renderBarChart(analyticsData.branch_wise || []);
                
                // Render new analytics charts
                const applications = applicationsData.data || applicationsData || [];
                const jobs = Array.isArray(jobsData) ? jobsData : jobsData.data || [];
                const students = analyticsData.students || [];
                
                console.log('üé® Rendering charts with:', { 
                    applicationsCount: applications.length, 
                    jobsCount: jobs.length, 
                    studentsCount: students.length 
                });
                
                if (applications.length > 0) {
                    renderApplicationStatusChart(applications);
                    renderTopCompaniesChart(applications);
                    renderApplicationsTrendChart(applications);
                } else {
                    console.warn('‚ö†Ô∏è No applications data to render');
                }
                
                if (students.length > 0) {
                    renderPackageRangeChart(students);
                    renderBranchComparisonChart(students, applications);
                } else {
                    console.warn('‚ö†Ô∏è No students data to render');
                }
                
            } catch(e) { 
                console.error('‚ùå Failed to load overview:', e); 
            }
        }

        let pieChart, barChart, appStatusChart, topCompaniesChart, trendChart, packageChart, branchComparisonChart;
        
        function renderPieChart(placed, total) {
            const ctx = document.getElementById('placementPieChart').getContext('2d');
            if (pieChart) pieChart.destroy();
            pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Placed', 'Unplaced'], datasets: [{ data: [placed, total - placed], backgroundColor: ['#22c55e', '#ef4444'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } } }
            });
        }

        function renderBarChart(branches) {
            const ctx = document.getElementById('deptBarChart').getContext('2d');
            if (barChart) barChart.destroy();
            barChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: branches.map(b => b.branch || 'Unknown'), datasets: [{ label: 'Placement Rate (%)', data: branches.map(b => b.percentage || 0), backgroundColor: 'rgba(124, 58, 237, 0.6)', borderColor: '#7c3aed', borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } }, plugins: { legend: { display: false } } }
            });
        }

        // NEW ANALYTICS CHARTS
        function renderApplicationStatusChart(applications) {
            const ctx = document.getElementById('applicationStatusChart')?.getContext('2d');
            if (!ctx) return;
            
            const statusCounts = applications.reduce((acc, app) => {
                acc[app.status || 'Applied'] = (acc[app.status || 'Applied'] || 0) + 1;
                return acc;
            }, {});
            
            if (appStatusChart) appStatusChart.destroy();
            appStatusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'],
                        borderWidth: 2,
                        borderColor: '#1a1a2e'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8', padding: 15 } }
                    }
                }
            });
        }

        function renderTopCompaniesChart(applications, companies) {
            const ctx = document.getElementById('topCompaniesChart')?.getContext('2d');
            if (!ctx) return;
            
            const companyCounts = applications.reduce((acc, app) => {
                const company = app.company_name || 'Unknown';
                acc[company] = (acc[company] || 0) + 1;
                return acc;
            }, {});
            
            const sorted = Object.entries(companyCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (topCompaniesChart) topCompaniesChart.destroy();
            topCompaniesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(c => c[0]),
                    datasets: [{
                        label: 'Applications',
                        data: sorted.map(c => c[1]),
                        backgroundColor: 'rgba(6, 182, 212, 0.7)',
                        borderColor: '#06b6d4',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#94a3b8' } },
                        y: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderApplicationsTrendChart(applications) {
            const ctx = document.getElementById('applicationsTrendChart')?.getContext('2d');
            if (!ctx) return;
            
            // Group by month
            const monthCounts = {};
            applications.forEach(app => {
                if (app.applied_at) {
                    const month = new Date(app.applied_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                    monthCounts[month] = (monthCounts[month] || 0) + 1;
                }
            });
            
            const labels = Object.keys(monthCounts).sort();
            const data = labels.map(l => monthCounts[l]);
            
            if (trendChart) trendChart.destroy();
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Applications',
                        data: data,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.2)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } }
                    }
                }
            });
        }

        function renderPackageRangeChart(students) {
            const ctx = document.getElementById('packageRangeChart')?.getContext('2d');
            if (!ctx) return;
            
            const ranges = { '0-5 LPA': 0, '5-10 LPA': 0, '10-15 LPA': 0, '15-20 LPA': 0, '20+ LPA': 0 };
            
            students.forEach(s => {
                if (s.placement_status === 'Placed' && s.package_lpa) {
                    const pkg = parseFloat(s.package_lpa);
                    if (pkg < 5) ranges['0-5 LPA']++;
                    else if (pkg < 10) ranges['5-10 LPA']++;
                    else if (pkg < 15) ranges['10-15 LPA']++;
                    else if (pkg < 20) ranges['15-20 LPA']++;
                    else ranges['20+ LPA']++;
                }
            });
            
            if (packageChart) packageChart.destroy();
            packageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'Students',
                        data: Object.values(ranges),
                        backgroundColor: ['#ef4444', '#f59e0b', '#22c55e', '#3b82f6', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderBranchComparisonChart(students, applications) {
            const ctx = document.getElementById('branchComparisonChart')?.getContext('2d');
            if (!ctx) return;
            
            const branchData = {};
            students.forEach(s => {
                const branch = s.branch || 'Unknown';
                if (!branchData[branch]) branchData[branch] = { applications: 0, placed: 0 };
                if (s.placement_status === 'Placed') branchData[branch].placed++;
            });
            
            applications.forEach(app => {
                const branch = app.student_branch || 'Unknown';
                if (branchData[branch]) branchData[branch].applications++;
            });
            
            const branches = Object.keys(branchData).slice(0, 6);
            
            if (branchComparisonChart) branchComparisonChart.destroy();
            branchComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: branches,
                    datasets: [
                        {
                            label: 'Applications',
                            data: branches.map(b => branchData[b]?.applications || 0),
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            borderColor: '#3b82f6',
                            borderWidth: 2
                        },
                        {
                            label: 'Placed',
                            data: branches.map(b => branchData[b]?.placed || 0),
                            backgroundColor: 'rgba(34, 197, 94, 0.6)',
                            borderColor: '#22c55e',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { color: '#94a3b8' } }
                    }
                }
            });
        }

        async function loadVerificationQueue() {
            const status = document.getElementById('verificationFilter')?.value || 'Pending';
            try {
                const data = await apiCall(`/admin/verification-queue?status=${status}`);
                const tbody = document.getElementById('verificationTableBody');
                if (!data.data || data.data.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No pending verifications</td></tr>'; return; }
                tbody.innerHTML = data.data.map(v => `<tr><td>${v.student_name || 'N/A'}</td><td>${v.student_email || 'N/A'}</td><td>${v.branch || 'N/A'}</td><td>${v.submitted_at ? new Date(v.submitted_at).toLocaleDateString() : 'N/A'}</td><td><span class="status-badge ${v.status?.toLowerCase()}">${v.status}</span></td><td>${v.status === 'Pending' ? `<button class="action-btn approve" onclick="approveVerification(${v.id})">Approve</button><button class="action-btn reject" onclick="rejectVerification(${v.id})">Reject</button>` : '-'}</td></tr>`).join('');
            } catch(e) { console.error('Failed to load verification queue:', e); }
        }

        async function approveVerification(id) {
            if (!confirm('Approve this student?')) return;
            const res = await apiCall(`/admin/verification/${id}/approve`, 'POST');
            if (res.success) { showToast('Student approved!', 'success'); loadVerificationQueue(); } else { showToast(res.error || 'Failed', 'error'); }
        }

        async function rejectVerification(id) {
            const reason = prompt('Rejection reason:');
            if (!reason) return;
            const res = await apiCall(`/admin/verification/${id}/reject`, 'POST', { reason });
            if (res.success) { showToast('Verification rejected', 'success'); loadVerificationQueue(); } else { showToast(res.error || 'Failed', 'error'); }
        }

        async function loadPendingJobs() {
            try {
                const data = await apiCall('/admin/pending-jobs');
                const tbody = document.getElementById('jobsTableBody');
                document.getElementById('pendingJobs').textContent = data?.length || 0;
                if (!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No pending jobs</td></tr>'; return; }
                tbody.innerHTML = data.map(j => `<tr><td>${j.company_name || 'N/A'}</td><td>${j.title}</td><td><span class="status-badge pending">${j.job_type}</span></td><td>${j.location || 'N/A'}</td><td>${j.salary_range || 'N/A'}</td><td>${j.application_deadline || 'N/A'}</td><td><button class="action-btn approve" onclick="approveJob(${j.id})">Approve</button><button class="action-btn reject" onclick="rejectJob(${j.id})">Reject</button></td></tr>`).join('');
            } catch(e) { console.error('Failed to load jobs:', e); }
        }

        async function approveJob(id) { const res = await apiCall(`/admin/approve-job/${id}`, 'PUT', { status: 'Approved' }); if (res.message) { showToast('Job approved!', 'success'); loadPendingJobs(); } else { showToast(res.error || 'Failed', 'error'); } }
        async function rejectJob(id) { const res = await apiCall(`/admin/approve-job/${id}`, 'PUT', { status: 'Rejected' }); if (res.message) { showToast('Job rejected', 'success'); loadPendingJobs(); } else { showToast(res.error || 'Failed', 'error'); } }

        async function loadBlacklist() {
            try {
                const data = await apiCall('/admin/blacklist/students');
                const tbody = document.getElementById('blacklistTableBody');
                if (!data.data || data.data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No blacklisted students</td></tr>'; return; }
                tbody.innerHTML = data.data.map(b => `<tr><td>${b.student_name || `ID: ${b.student_id}`}</td><td>${b.reason}</td><td><span class="status-badge ${b.severity?.toLowerCase()}">${b.severity}</span></td><td>${b.blacklisted_date ? new Date(b.blacklisted_date).toLocaleDateString() : 'N/A'}</td><td><button class="action-btn approve" onclick="removeBlacklist(${b.id})">Remove</button></td></tr>`).join('');
            } catch(e) { console.error('Failed to load blacklist:', e); }
        }

        function openBlacklistModal() { document.getElementById('blacklistModal').classList.add('active'); }

        async function addToBlacklist(e) {
            e.preventDefault();
            const body = { student_id: document.getElementById('blStudentId').value, reason: document.getElementById('blReason').value, severity: document.getElementById('blSeverity').value, duration_days: parseInt(document.getElementById('blDuration').value) || 0 };
            const res = await apiCall('/admin/blacklist/add', 'POST', body);
            if (res.success) { showToast('Student blacklisted', 'success'); closeModal('blacklistModal'); loadBlacklist(); } else { showToast(res.error || 'Failed', 'error'); }
        }

        async function removeBlacklist(id) { if (!confirm('Remove from blacklist?')) return; const res = await apiCall(`/admin/blacklist/remove/${id}`, 'POST'); if (res.success) { showToast('Removed from blacklist', 'success'); loadBlacklist(); } }

        async function loadMasterData() {
            try {
                const [deps, counts] = await Promise.all([
                    apiCall('/admin/departments'),
                    apiCall('/admin/students/branch-counts').catch(() => ({ data: [] }))
                ]);

                const depList = document.getElementById('departmentsList');
                if (depList && deps.data) {
                    const countMap = {};
                    (counts.data || []).forEach(c => { if (c.branch) countMap[c.branch] = c; });

                    depList.innerHTML = deps.data.map(d => {
                        const branchName = d.name;
                        const c = countMap[branchName];
                        const total = c ? (c.total_students || 0) : 0;
                        const code = d.code || '';
                        return `
                            <div class="item-chip branch-chip" role="button" tabindex="0" data-branch="${branchName}" onclick="selectBranch('${String(branchName).replace(/'/g, "\\'")}')">
                                <div style="display:flex; flex-direction:column; gap: 2px;">
                                    <span>${branchName}</span>
                                    <span class="minor">${code}</span>
                                </div>
                                <span class="count-pill" title="Registered students">${total}</span>
                            </div>
                        `;
                    }).join('');
                }
            } catch(e) {}
            try { const batches = await apiCall('/admin/batch-years'); const batchList = document.getElementById('batchesList'); if (batches.data) { batchList.innerHTML = batches.data.map(b => `<div class="item-chip"><span>${b.year}</span><span class="minor">${b.academic_session || ''}</span></div>`).join(''); } } catch(e) {}
            try { const skills = await apiCall('/admin/skills'); const skillList = document.getElementById('skillsList'); if (skills.data) { skillList.innerHTML = skills.data.map(s => `<div class="item-chip"><span>${s.name}</span><span class="minor">${s.category || ''}</span></div>`).join(''); } } catch(e) {}
        }

        let selectedBranchName = null;

        function closeBranchStudents() {
            selectedBranchName = null;
            document.querySelectorAll('.branch-chip').forEach(el => el.classList.remove('active'));
            const panel = document.getElementById('branchStudentsPanel');
            if (panel) panel.style.display = 'none';
        }

        async function selectBranch(branchName) {
            selectedBranchName = branchName;

            document.querySelectorAll('.branch-chip').forEach(el => {
                el.classList.toggle('active', el.getAttribute('data-branch') === branchName);
            });

            const panel = document.getElementById('branchStudentsPanel');
            const title = document.getElementById('branchStudentsTitle');
            const summary = document.getElementById('branchStudentsSummary');
            const body = document.getElementById('branchStudentsBody');
            if (!panel || !title || !summary || !body) return;

            panel.style.display = 'block';
            title.textContent = `${branchName} Students`;
            summary.textContent = 'Loading students...';
            body.innerHTML = '<tr><td colspan="6" class="empty-state">Loading...</td></tr>';

            try {
                const res = await apiCall(`/admin/students?branch=${encodeURIComponent(branchName)}`);
                const students = (res && res.data) ? res.data : [];
                const total = students.length;
                const placed = students.filter(s => (s.placement_status || '').toLowerCase() === 'placed').length;
                const unplaced = total - placed;
                summary.textContent = `${total} registered ‚Ä¢ ${placed} placed ‚Ä¢ ${unplaced} unplaced`;

                if (students.length === 0) {
                    body.innerHTML = '<tr><td colspan="6" class="empty-state">No students found for this branch</td></tr>';
                    return;
                }

                body.innerHTML = students.map(s => {
                    const status = (s.placement_status || 'Unplaced');
                    const statusLower = status.toLowerCase();
                    const statusBadge = statusLower === 'placed'
                        ? '<span class="status-badge verified">Placed</span>'
                        : '<span class="status-badge pending">Unplaced</span>';
                    const pkg = Number(s.package_lpa);
                    const pkgText = (Number.isFinite(pkg) && pkg > 0) ? pkg.toFixed(2) : '-';
                    return `
                        <tr>
                            <td>${s.full_name || 'N/A'}</td>
                            <td>${s.email || 'N/A'}</td>
                            <td>${s.enrollment_number || 'N/A'}</td>
                            <td>${(s.cgpa ?? 0).toString()}</td>
                            <td>${statusBadge}</td>
                            <td>${pkgText}</td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to load branch students:', e);
                summary.textContent = 'Failed to load students';
                body.innerHTML = '<tr><td colspan="6" class="empty-state">Failed to load students</td></tr>';
            }
        }

        let currentAddType = '';
        function openAddModal(type) {
            currentAddType = type;
            const title = document.getElementById('addModalTitle');
            const fields = document.getElementById('addFormFields');
            if (type === 'department') { title.textContent = 'Add Department'; fields.innerHTML = `<div class="form-group"><label>Name</label><input type="text" id="addName" required></div><div class="form-group"><label>Code</label><input type="text" id="addCode" required></div>`; }
            else if (type === 'batch') { title.textContent = 'Add Batch Year'; fields.innerHTML = `<div class="form-group"><label>Year</label><input type="number" id="addYear" required></div><div class="form-group"><label>Session (e.g. 2024-2025)</label><input type="text" id="addSession"></div>`; }
            else if (type === 'skill') { title.textContent = 'Add Skill'; fields.innerHTML = `<div class="form-group"><label>Name</label><input type="text" id="addName" required></div><div class="form-group"><label>Category</label><select id="addCategory"><option>Programming</option><option>Framework</option><option>Database</option><option>Cloud</option><option>DevOps</option><option>Other</option></select></div>`; }
            document.getElementById('addModal').classList.add('active');
        }

        async function submitAddForm(e) {
            e.preventDefault();
            let endpoint, body;
            if (currentAddType === 'department') { endpoint = '/admin/departments'; body = { name: document.getElementById('addName').value, code: document.getElementById('addCode').value }; }
            else if (currentAddType === 'batch') { endpoint = '/admin/batch-years'; body = { year: parseInt(document.getElementById('addYear').value), academic_session: document.getElementById('addSession').value }; }
            else if (currentAddType === 'skill') { endpoint = '/admin/skills'; body = { name: document.getElementById('addName').value, category: document.getElementById('addCategory').value }; }
            const res = await apiCall(endpoint, 'POST', body);
            if (res.success) { showToast('Added successfully', 'success'); closeModal('addModal'); loadMasterData(); } else { showToast(res.error || 'Failed', 'error'); }
        }

        async function loadAnnouncements() {
            try {
                const data = await apiCall('/admin/announcements');
                const list = document.getElementById('announcementsList');
                if (!data || data.length === 0) { list.innerHTML = '<p class="minor">No announcements yet</p>'; return; }
                list.innerHTML = data.slice(0, 5).map(a => `<div class="chip" style="margin-bottom: 12px; display: block;"><strong>${a.title}</strong><p class="minor" style="margin-top: 4px;">${a.message}</p><span class="minor">${new Date(a.created_at).toLocaleDateString()}</span></div>`).join('');
            } catch(e) {}
        }

        async function createAnnouncement(e) {
            e.preventDefault();
            const body = { title: document.getElementById('annTitle').value, message: document.getElementById('annMessage').value, target_role: document.getElementById('annTarget').value || null };
            const res = await apiCall('/admin/announcements', 'POST', body);
            if (res.message || res.id) { showToast('Announcement created!', 'success'); document.getElementById('announcementForm').reset(); loadAnnouncements(); } else { showToast(res.error || 'Failed', 'error'); }
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function logout() { 
          console.log('Admin logout clicked');
          localStorage.clear(); 
          sessionStorage.clear();
          window.location.href = 'index.html'; 
        }

        // =============== SESSION & BATCH MANAGEMENT ===============
        let currentSessionId = null;
        let allSessions = [];
        let allBatches = [];

        // =============== COMPANY PROGRESS TRACKING ===============
        async function loadCompanyProgress() {
            console.log('üè¢ Loading company progress...');
            const container = document.getElementById('companyProgressList');
            if (!container) {
                console.error('‚ùå companyProgressList container not found!');
                return;
            }
            
            try {
                console.log('üìä Fetching company data...');
                // Preferred: ask backend for aggregated progress (accurate placed counts)
                try {
                    const progressRes = await apiCall('/admin/company-progress');
                    const rows = Array.isArray(progressRes) ? progressRes : progressRes.data || [];
                    if (rows.length > 0) {
                        const companyList = rows
                            .map(r => ({
                                id: r.company_id,
                                name: r.company_name || 'Unknown Company',
                                industry: r.industry || null,
                                website: r.company_website || null,
                                logo_url: r.logo_url || null,
                                totalJobs: r.total_jobs || 0,
                                approvedJobs: r.approved_jobs || 0,
                                pendingJobs: r.pending_jobs || 0,
                                totalApplications: r.total_applications || 0,
                                shortlisted: r.shortlisted || 0,
                                inInterview: r.in_interview || 0,
                                offered: r.offered || 0,
                                selected: r.selected || 0,
                                rejected: r.rejected || 0,
                                offersMade: r.offers_made || 0,
                                placedStudents: r.placed_students || 0,
                                highestPackage: r.highest_package || 0,
                                jobTypes: new Set()
                            }))
                            .sort((a, b) => (b.placedStudents - a.placedStudents) || (b.totalApplications - a.totalApplications));

                        container.innerHTML = companyList.map(company => {
                            const placementRate = company.totalApplications > 0 ? ((company.placedStudents / company.totalApplications) * 100).toFixed(1) : 0;
                            const activeRounds = company.shortlisted + company.inInterview + company.offered;
                            const website = company.website ? String(company.website) : '';
                            const safeWebsiteHref = website && /^https?:\/\//i.test(website) ? website : (website ? `https://${website}` : '');
                            return `
                                <div class="card" style="padding: 20px; background: var(--glass); border: var(--border); border-radius: var(--radius);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                        <div>
                                            <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${company.name}</h4>
                                            <div class="minor" style="margin-bottom: 8px; color: var(--muted);">
                                                ${company.industry ? `<span>${company.industry}</span>` : ''}
                                                ${company.industry && safeWebsiteHref ? `<span style="opacity: 0.6; margin: 0 6px;">‚Ä¢</span>` : ''}
                                                ${safeWebsiteHref ? `<a href="${safeWebsiteHref}" target="_blank" rel="noopener noreferrer" style="color: var(--muted); text-decoration: underline;">Website</a>` : ''}
                                            </div>
                                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                ${company.totalJobs === 0 ? `<span class="badge" style="background: rgba(255,255,255,0.10); color: var(--muted);">No jobs posted yet</span>` : ''}
                                                ${company.pendingJobs > 0 ? `<span class="badge" style="background: rgba(245, 158, 11, 0.18); color: #f59e0b;">${company.pendingJobs} Pending</span>` : ''}
                                                ${company.highestPackage > 0 ? `<span class="badge badge-amber">Up to ${Number(company.highestPackage).toFixed(2)} LPA</span>` : ''}
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 24px; font-weight: 700; color: #10b981;">${company.placedStudents}</div>
                                            <div style="font-size: 12px; color: var(--muted);">Students Placed</div>
                                        </div>
                                    </div>

                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                        <div>
                                            <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Jobs Posted</div>
                                            <div style="font-size: 20px; font-weight: 600;">${company.totalJobs}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Total Applications</div>
                                            <div style="font-size: 20px; font-weight: 600;">${company.totalApplications}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">In Process</div>
                                            <div style="font-size: 20px; font-weight: 600; color: #f59e0b;">${activeRounds}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Offers Made</div>
                                            <div style="font-size: 20px; font-weight: 600; color: #06b6d4;">${company.offersMade}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Placement Rate</div>
                                            <div style="font-size: 20px; font-weight: 600; color: #10b981;">${placementRate}%</div>
                                        </div>
                                    </div>

                                    <div style="margin-bottom: 12px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                                            <span style="color: var(--muted);">Hiring Progress</span>
                                            <span style="color: var(--muted);">${company.placedStudents}/${company.totalApplications}</span>
                                        </div>
                                        <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                            <div style="width: ${placementRate}%; height: 100%; background: linear-gradient(90deg, #10b981, #06b6d4); transition: width 0.3s ease;"></div>
                                        </div>
                                    </div>

                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">‚úì ${company.placedStudents} Placed</span>
                                        <span class="badge" style="background: rgba(6, 182, 212, 0.2); color: #06b6d4;">üéØ ${company.offersMade} Offers</span>
                                        <span class="badge" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;">üìã ${company.inInterview} In Interview</span>
                                        <span class="badge" style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6;">‚ö° ${company.shortlisted} Shortlisted</span>
                                        ${company.rejected > 0 ? `<span class="badge" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">‚úó ${company.rejected} Rejected</span>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');

                        console.log('‚ú® Company progress cards rendered successfully (server-side)');
                        return;
                    }
                } catch (e) {
                    // fall back to client-side aggregation below
                    console.warn('Company progress endpoint unavailable, falling back:', e);
                }

                // Fetch data from multiple endpoints
                const [companiesRes, applicationsRes, jobsRes] = await Promise.all([
                    apiCall('/admin/companies').catch(() => []),
                    apiCall('/admin/applications').catch(() => ({ data: [] })),
                    apiCall('/admin/jobs').catch(() => [])
                ]);
                
                const companies = Array.isArray(companiesRes) ? companiesRes : companiesRes.data || [];
                const applications = Array.isArray(applicationsRes) ? applicationsRes : applicationsRes.data || [];
                const jobs = Array.isArray(jobsRes) ? jobsRes : jobsRes.data || [];
                
                console.log(`üì¶ Data loaded - Jobs: ${jobs.length}, Applications: ${applications.length}`);
                
                // Process company-wise statistics
                const companyStats = {};

                // Helper: safe numeric salary parse (kept as fallback only)
                const parsePackageFromSalaryRange = (salaryRange) => {
                    if (!salaryRange) return 0;
                    const raw = String(salaryRange);
                    const parts = raw.split('-');
                    const candidate = (parts.length > 1 ? parts[1] : parts[0]).trim();
                    const num = parseFloat(candidate);
                    return Number.isFinite(num) ? num : 0;
                };

                // Initialize stats for *all registered companies* (even if they posted no jobs yet)
                companies.forEach(c => {
                    const id = c.id;
                    if (!id) return;
                    companyStats[id] = {
                        id,
                        name: c.company_name || 'Unknown Company',
                        industry: c.industry || null,
                        website: c.company_website || c.website || null,
                        logo_url: c.logo_url || null,
                        totalJobs: 0,
                        approvedJobs: 0,
                        pendingJobs: 0,
                        totalApplications: 0,
                        shortlisted: 0,
                        inInterview: 0,
                        offered: 0,
                        selected: 0,
                        rejected: 0,
                        highestPackage: 0,
                        jobTypes: new Set()
                    };
                });
                
                // Add job stats
                jobs.forEach(job => {
                    const companyId = job.company_id;
                    if (!companyId) return;

                    if (!companyStats[companyId]) {
                        companyStats[companyId] = {
                            id: companyId,
                            name: job.company_name || 'Unknown Company',
                            industry: null,
                            website: null,
                            logo_url: null,
                            totalJobs: 0,
                            approvedJobs: 0,
                            pendingJobs: 0,
                            totalApplications: 0,
                            shortlisted: 0,
                            inInterview: 0,
                            offered: 0,
                            selected: 0,
                            rejected: 0,
                            highestPackage: 0,
                            jobTypes: new Set()
                        };
                    }

                    companyStats[companyId].totalJobs++;
                    if (job.status === 'Approved') companyStats[companyId].approvedJobs++;
                    if (job.status === 'Pending') companyStats[companyId].pendingJobs++;
                    if (job.job_type) companyStats[companyId].jobTypes.add(job.job_type);
                    const pkg = parsePackageFromSalaryRange(job.salary_range);
                    if (pkg > 0) companyStats[companyId].highestPackage = Math.max(companyStats[companyId].highestPackage, pkg);
                });
                
                // Count applications by company and status
                applications.forEach(app => {
                    const companyId = app.company_id;
                    if (!companyId || !companyStats[companyId]) return;

                    companyStats[companyId].totalApplications++;

                    const status = app.status?.toLowerCase() || '';
                    if (status === 'shortlisted') companyStats[companyId].shortlisted++;
                    else if (status === 'interview') companyStats[companyId].inInterview++;
                    else if (status === 'offered') companyStats[companyId].offered++;
                    else if (status === 'selected' || status === 'hired') companyStats[companyId].selected++;
                    else if (status === 'rejected') companyStats[companyId].rejected++;
                });
                
                // Convert to array and sort by total placements, then applications
                const companyList = Object.values(companyStats).sort((a, b) => (b.selected - a.selected) || (b.totalApplications - a.totalApplications));
                
                console.log(`‚úÖ Processed ${companyList.length} companies`);
                
                if (companyList.length === 0) {
                    console.log('‚ö†Ô∏è No company data to display');
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--muted);">No company data available yet</div>';
                    return;
                }
                
                // Render company progress cards
                container.innerHTML = companyList.map(company => {
                    const placementRate = company.totalApplications > 0 ? ((company.selected / company.totalApplications) * 100).toFixed(1) : 0;
                    const activeRounds = company.shortlisted + company.inInterview + company.offered;
                    const website = company.website ? String(company.website) : '';
                    const safeWebsiteHref = website && /^https?:\/\//i.test(website) ? website : (website ? `https://${website}` : '');
                    
                    return `
                        <div class="card" style="padding: 20px; background: var(--glass); border: var(--border); border-radius: var(--radius);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                <div>
                                    <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${company.name}</h4>
                                    <div class="minor" style="margin-bottom: 8px; color: var(--muted);">
                                        ${company.industry ? `<span>${company.industry}</span>` : ''}
                                        ${company.industry && safeWebsiteHref ? `<span style="opacity: 0.6; margin: 0 6px;">‚Ä¢</span>` : ''}
                                        ${safeWebsiteHref ? `<a href="${safeWebsiteHref}" target="_blank" rel="noopener noreferrer" style="color: var(--muted); text-decoration: underline;">Website</a>` : ''}
                                    </div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        ${Array.from(company.jobTypes).map(type => 
                                            `<span class="badge badge-blue">${type}</span>`
                                        ).join('')}
                                        ${company.totalJobs === 0 ? `<span class="badge" style="background: rgba(255,255,255,0.10); color: var(--muted);">No jobs posted yet</span>` : ''}
                                        ${company.pendingJobs > 0 ? `<span class="badge" style="background: rgba(245, 158, 11, 0.18); color: #f59e0b;">${company.pendingJobs} Pending</span>` : ''}
                                        ${company.highestPackage > 0 ? 
                                            `<span class="badge badge-amber">Up to ${company.highestPackage} LPA</span>` : ''}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 24px; font-weight: 700; color: #10b981;">${company.selected}</div>
                                    <div style="font-size: 12px; color: var(--muted);">Students Placed</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                <div>
                                    <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Jobs Posted</div>
                                    <div style="font-size: 20px; font-weight: 600;">${company.totalJobs}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Total Applications</div>
                                    <div style="font-size: 20px; font-weight: 600;">${company.totalApplications}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">In Process</div>
                                    <div style="font-size: 20px; font-weight: 600; color: #f59e0b;">${activeRounds}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Offers Made</div>
                                    <div style="font-size: 20px; font-weight: 600; color: #06b6d4;">${company.offered}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Placement Rate</div>
                                    <div style="font-size: 20px; font-weight: 600; color: #10b981;">${placementRate}%</div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                                    <span style="color: var(--muted);">Hiring Progress</span>
                                    <span style="color: var(--muted);">${company.selected}/${company.totalApplications}</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${placementRate}%; height: 100%; background: linear-gradient(90deg, #10b981, #06b6d4); transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">‚úì ${company.selected} Selected</span>
                                <span class="badge" style="background: rgba(6, 182, 212, 0.2); color: #06b6d4;">üéØ ${company.offered} Offered</span>
                                <span class="badge" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;">üìã ${company.inInterview} In Interview</span>
                                <span class="badge" style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6;">‚ö° ${company.shortlisted} Shortlisted</span>
                                ${company.rejected > 0 ? 
                                    `<span class="badge" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">‚úó ${company.rejected} Rejected</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log('‚ú® Company progress cards rendered successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading company progress:', error);
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--muted);">Failed to load company data</div>';
            }
        }

        async function loadSessions() {
            try {
                const response = await apiCall('/admin/sessions');
                
                // Ensure we have an array
                const sessions = Array.isArray(response) ? response : [];
                allSessions = sessions;
                
                const selector = document.getElementById('session-selector');
                if (!selector) return;
                
                if (sessions.length === 0) {
                    selector.innerHTML = '<option value="">No sessions available</option>';
                    return;
                }
                
                const activeSession = sessions.find(s => s.status === 'Active');
                
                if (activeSession) {
                    currentSessionId = activeSession.id;
                }
                
                selector.innerHTML = sessions.map(s => 
                    `<option value="${s.id}" ${s.status === 'Active' ? 'selected' : ''}>
                        ${s.name} (${s.status}) - ${s.job_count || 0} jobs, ${s.application_count || 0} apps
                    </option>`
                ).join('');
                
                // Remove existing listeners before adding new one
                const newSelector = selector.cloneNode(true);
                selector.parentNode.replaceChild(newSelector, selector);
                
                newSelector.addEventListener('change', async (e) => {
                    const sessionId = e.target.value;
                    if (sessionId && confirm('Switch active session? This will affect all users.')) {
                        await setActiveSession(sessionId);
                    }
                });
            } catch (err) {
                console.error('Load sessions error:', err);
                showToast('Failed to load sessions: ' + err.message, 'error');
            }
        }

        async function setActiveSession(sessionId) {
            try {
                await apiCall(`/admin/sessions/${sessionId}/set-active`, 'PUT');
                currentSessionId = sessionId;
                showToast('Session activated successfully', 'success');
                await loadSessions();
                await loadOverview();
            } catch (err) {
                showToast('Failed to activate session: ' + err.message, 'error');
            }
        }

        async function refreshSessionData() {
            showToast('Refreshing...', 'info');
            await loadSessions();
            await loadOverview();
        }

        function openSessionModal() {
            loadSessionsList();
            document.getElementById('session-modal').classList.add('active');
        }

        function closeSessionModal() {
            document.getElementById('session-modal').classList.remove('active');
            document.getElementById('session-form').reset();
        }

        async function loadSessionsList() {
            const list = document.getElementById('session-list');
            list.innerHTML = '<p>Loading...</p>';
            
            try {
                const sessions = await apiCall('/admin/sessions');
                
                if (sessions.length === 0) {
                    list.innerHTML = '<p class="minor">No sessions created yet</p>';
                    return;
                }
                
                list.innerHTML = sessions.map(s => `
                    <div class="card animate" style="margin-bottom: 12px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4>${s.name}</h4>
                                <p class="minor">${s.start_year}-${s.end_year} | ${s.start_date} to ${s.end_date}</p>
                                <div style="margin-top: 8px;">
                                    <span class="badge badge-${s.status === 'Active' ? 'green' : s.status === 'Upcoming' ? 'blue' : 'amber'}">${s.status}</span>
                                    <span class="badge badge-blue">${s.job_count} jobs</span>
                                    <span class="badge badge-blue">${s.application_count} apps</span>
                                    <span class="badge badge-blue">${s.batch_count} batches</span>
                                </div>
                                ${s.description ? `<p class="minor" style="margin-top: 8px;">${s.description}</p>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${s.status !== 'Active' ? 
                                    `<button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="setActiveSession(${s.id})">Activate</button>` : ''}
                                <button class="btn btn-ghost" style="padding: 6px 12px; font-size: 12px;" onclick="deleteSession(${s.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                list.innerHTML = '<p class="minor">Error loading sessions</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize session form handler
            const sessionForm = document.getElementById('session-form');
            if (sessionForm) {
                sessionForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating...';
                    
                    const data = {
                        name: document.getElementById('session-name').value,
                        start_year: parseInt(document.getElementById('session-start-year').value),
                        end_year: parseInt(document.getElementById('session-end-year').value),
                        start_date: document.getElementById('session-start-date').value,
                        end_date: document.getElementById('session-end-date').value,
                        description: document.getElementById('session-description').value,
                        status: document.getElementById('session-status').value
                    };
                    
                    try {
                        const response = await apiCall('/admin/sessions', 'POST', data);
                        showToast(response.message || 'Session created successfully', 'success');
                        e.target.reset();
                        await loadSessionsList();
                        await loadSessions();
                    } catch (err) {
                        showToast('Failed to create session: ' + err.message, 'error');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
            
            // Initialize batch form handler
            const batchForm = document.getElementById('batch-form');
            if (batchForm) {
                batchForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating...';
                    
                    const data = {
                        batch_code: document.getElementById('batch-code').value,
                        start_year: parseInt(document.getElementById('batch-start-year').value),
                        end_year: parseInt(document.getElementById('batch-end-year').value),
                        degree: document.getElementById('batch-degree').value,
                        program: document.getElementById('batch-program').value,
                        description: document.getElementById('batch-description').value,
                        status: document.getElementById('batch-status').value
                    };
                    
                    try {
                        const response = await apiCall('/admin/batches', 'POST', data);
                        showToast(response.message || 'Batch created successfully', 'success');
                        e.target.reset();
                        await loadBatchesList();
                    } catch (err) {
                        showToast('Failed to create batch: ' + err.message, 'error');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
            
            // Initialize on page load
            loadSessions();
        });

        async function deleteSession(sessionId) {
            if (!confirm('Are you sure? This cannot be undone if the session has jobs or applications.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/sessions/${sessionId}`, 'DELETE');
                showToast('Session deleted successfully', 'success');
                await loadSessionsList();
                await loadSessions();
            } catch (err) {
                showToast('Failed to delete session: ' + err.message, 'error');
            }
        }

        // BATCH MANAGEMENT
        function openBatchModal() {
            loadBatchesList();
            document.getElementById('batch-modal').classList.add('active');
        }

        function closeBatchModal() {
            document.getElementById('batch-modal').classList.remove('active');
            document.getElementById('batch-form').reset();
        }

        async function loadBatchesList() {
            const list = document.getElementById('batch-list');
            list.innerHTML = '<p>Loading...</p>';
            
            try {
                const batches = await apiCall('/admin/batches');
                allBatches = batches || [];
                
                if (batches.length === 0) {
                    list.innerHTML = '<p class="minor">No batches created yet</p>';
                    return;
                }
                
                list.innerHTML = batches.map(b => `
                    <div class="card animate" style="margin-bottom: 12px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4>${b.batch_code}</h4>
                                <p class="minor">${b.degree}${b.program ? ' - ' + b.program : ''}</p>
                                <div style="margin-top: 8px;">
                                    <span class="badge badge-${b.status === 'Active' ? 'green' : b.status === 'Graduated' ? 'blue' : 'amber'}">${b.status}</span>
                                    <span class="badge badge-blue">${b.student_count} students</span>
                                    <span class="badge badge-blue">${b.session_count} sessions</span>
                                </div>
                                ${b.description ? `<p class="minor" style="margin-top: 8px;">${b.description}</p>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-ghost" style="padding: 6px 12px; font-size: 12px;" onclick="deleteBatch(${b.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                list.innerHTML = '<p class="minor">Error loading batches</p>';
            }
        }

        async function deleteBatch(batchId) {
            if (!confirm('Are you sure? This will fail if students are assigned to this batch.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/batches/${batchId}`, 'DELETE');
                showToast('Batch deleted successfully', 'success');
                await loadBatchesList();
            } catch (err) {
                showToast('Failed to delete batch: ' + err.message, 'error');
            }
        }
    </script>

    <!-- Session Management Modal -->
    <div id="session-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h3 id="session-modal-title">Manage Placement Sessions</h3>
            <div id="session-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Sessions will be loaded here -->
            </div>
            
            <form id="session-form" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <h4>Create New Session</h4>
                <div class="form-group">
                    <label>Session Name *</label>
                    <input type="text" id="session-name" placeholder="e.g., 2024-25 Placement Session" required>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Start Year *</label>
                        <input type="number" id="session-start-year" min="2020" max="2050" required>
                    </div>
                    <div class="form-group">
                        <label>End Year *</label>
                        <input type="number" id="session-end-year" min="2020" max="2050" required>
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="session-start-date" required>
                    </div>
                    <div class="form-group">
                        <label>End Date *</label>
                        <input type="date" id="session-end-date" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="session-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="session-status">
                        <option value="Upcoming">Upcoming</option>
                        <option value="Active">Active</option>
                        <option value="Archived">Archived</option>
                    </select>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Create Session</button>
                    <button type="button" class="btn btn-ghost" onclick="closeSessionModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Batch Management Modal -->
    <div id="batch-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h3>Manage Academic Batches</h3>
            <div id="batch-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Batches will be loaded here -->
            </div>
            
            <form id="batch-form" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <h4>Create New Batch</h4>
                <div class="form-group">
                    <label>Batch Code * (e.g., 2021-2025)</label>
                    <input type="text" id="batch-code" placeholder="2021-2025" required>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Start Year *</label>
                        <input type="number" id="batch-start-year" min="2000" max="2050" required>
                    </div>
                    <div class="form-group">
                        <label>End Year *</label>
                        <input type="number" id="batch-end-year" min="2000" max="2050" required>
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Degree *</label>
                        <input type="text" id="batch-degree" placeholder="B.Tech" required>
                    </div>
                    <div class="form-group">
                        <label>Program</label>
                        <input type="text" id="batch-program" placeholder="Computer Science">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="batch-description" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="batch-status">
                        <option value="Active">Active</option>
                        <option value="Graduated">Graduated</option>
                        <option value="Archived">Archived</option>
                    </select>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Create Batch</button>
                    <button type="button" class="btn btn-ghost" onclick="closeBatchModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
